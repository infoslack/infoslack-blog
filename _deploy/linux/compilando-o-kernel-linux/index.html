<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8">
    <meta name="author" content="Daniel Romero" />
    <meta name="description" content="Compilando o Kernel Linux"/>
    <meta name="keywords" content="linux, kernel, compilação, make, modules"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="google-site-verification" content="-hEvNN86IOrYXeIdV4odleriXAkBE5PAV_Peb2niNZw" />
    <title>Compilando o Kernel Linux</title>
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="/css/syntax.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
    <script type="text/javascript" src="//use.typekit.net/yed8yuc.js"></script>
    <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
  </head>
  <body>

    <div class="site">
      <div class="header">
        <h1 class="title"><a href="/">root@infoslack:~#</a></h1>
        <a class="extra" href="/">home</a>
        <a class="extra" href="/livro">livro</a>
        <a class="extra" href="/about">about</a>
        <a class="extra" href="http://infoslack.com/atom.xml"><i class="fa fa-rss"></i></a>
      </div>

      <h2>Compilando o Kernel Linux</h2>
<p class="meta">04/11/2013</p>

<div class="post">
<h3>Motivação</h3>

<p>Você deve estar se perguntando, por que raios vou querer compilar ou
recompilar o kernel ?</p>

<p>Bem um dos principais motivos é a otimização, para moldar o kernel de acordo
com o seu hardware, outro bom motivo seria aplicar patches ao kernel para
eliminar bugs. O kernel Linux por default suporta uma infinidade de
dispositivos além de muitos, muitos recursos.</p>

<p>Um bom exemplo disso é o suporte a rádio amador que vem ativo por padrão:</p>

<p><img src="/images/kernel-menu.png" alt="Suporte a rádio amador ativo no kernel" /></p>

<p>Além desse exemplo existe ainda uma infinidade de outros módulos que dependendo
do nosso hardware não é utilizado e mesmo assim é carregado no boot.</p>

<h3>Relembrando os tipos de kernel</h3>

<p>Antes de prosseguir vamos relembrar os tipos de kernel e entender um pouco
sobre como funciona cada tipo.</p>

<p><code>Monolítico</code> é o kernel que une todos os módulos e subsistemas em um único
arquivo executável. Os módulos apesar de não estarem embutidos no código
do kernel, são executados no espaço de memória usado pelo kernel ou
(kernel space), dessa forma o funcionamento continua sendo centralizado.
Essa característica faz com que esse tipo de kernel seja mais rápido que outros.
O Linux, BSD e FreeBSD são exemplos de kernel monolítico.</p>

<p><code>Microkernel</code> é um kernel modular, grande parte dos subsistemas ficam no
(user space) e se comunicam com o núcleo por meio de mensagens. Esse tipo
de kernel é bastante flexível, Minix e OpenSolaris são exemplos desse
tipo de kernel.</p>

<p><code>Híbrido</code> é uma mistura de kernel monolítico com microkernel, ele mantém
alguns subsistemas em seu núcleo e se comunica com os módulos por troca de
mensagens. Por conta disso, possui desempenho menor. Mac OS e Windows são
exemplos de kernel híbrido.</p>

<p>Agora que você já relembrou os tipos de kernel e como os módulos são tratados,
podemos continuar!</p>

<h3>A compilação</h3>

<p>O primeiro passo para o processo de compilação é o download do código-fonte:
<a href="https://www.kernel.org/">kernel.org</a> vale lembrar que é sempre bom baixar
a versão estável.</p>

<p>Feito o download, descompacte o kernel no diretório <code>/usr/src</code> e refaça o
link simbólico existente chamado linux para que ele aponte para o diretório
do seu novo kernel.
Entre no diretório do novo kernel que será compilado e acione a interface
de configuração.</p>

<p>Veja o exemplo:</p>

<div class="highlight"><pre><code class="bash"><span class="nv">$ </span><span class="nb">cd</span> /usr/src
<span class="nv">$ </span>ls
linux@  linux-3.10.17/  linux-3.8.4/
<span class="nv">$ </span>ls -l linux
lrwxrwxrwx 1 root root 13 Oct 27 15:09 linux -&gt; linux-3.10.17/
<span class="nv">$ </span><span class="nb">cd </span>linux
<span class="nv">$ </span>make menuconfig
</code></pre></div>


<p><img src="/images/menuconfig.png" alt="make menuconfig" /></p>

<p>A configuração é a parte mais complexa, aqui você escolhe os módulos que
serão acoplados ao kernel, quais serão ativos e quais não estarão disponíveis.</p>

<p>Para compilar um kernel do (zero) é preciso obter todas as informações sobre
o hardware, com os comandos <code>lspci</code>, <code>lscpu</code>, <code>lsusb</code> e <code>dmidecode</code> é possível
obter todas as informações necessárias sobre o hardware para esse processo.</p>

<p>No menu de configuração temos opções para a escolha dos módulos, <code>[ * ]</code> indica
que o módulo está habilitado para ser incorporado ao kernel na compilação,
<code>[  ]</code> desabilitado e <code>[ M ]</code> ficará habilitado mas não incorporado ao kernel.</p>

<p>Aqui vamos focar na seguinte situação, você possui uma máquina com uma
distribuição linux instalada e deseja compilar uma versão de kernel mais
atual e de quebra, escolher alguns módulos próprios pro seu hardware.</p>

<p>Como já temos uma distro instalada e funcionando com o nosso hardware atual,
podemos pegar a atual configuração e utilizar como ponto de partida para a
nova compilação. Para isso utilizamos um arquivo de configuração que existe
no diretório <code>/boot</code> esse arquivo contém informações sobre os módulos do kernel
que serão carregados durante a inicialização e quais serão ativos por padrão.</p>

<p>O que deve ser feito é copiar o arquivo de configuração para o diretório do
novo kernel que será compilado para servir de base no processo de escolha de
módulos.</p>

<div class="highlight"><pre><code class="bash"><span class="nv">$ </span>cp /boot/config /usr/src/linux/.config
</code></pre></div>


<p>Após a cópia podemos executar a configuração com <code>make menuconfig</code>,
de forma automática ele utilizará o arquivo <code>.config</code> que copiamos de <code>/boot</code>.
Feito isso, após o menu de configurações ser exibido podemos por exemplo escolher
o nosso modelo de processador e ainda descartar o suporte a outros modelos
fazendo com que o kernel utilize um módulo específico para o hardware em
vez de um módulo genérico.</p>

<p><code>Processor type and features</code> ---> <code>Processor family</code></p>

<p><img src="/images/processor.png" alt="Processor family" /></p>

<p>A opção marcada no exemplo é referente a um modelo de processador Intel,
dessa forma o kernel utilizará o módulo específico em vez do genérico.
Sendo assim no caso do exemplo, poderia ser deabilitado todos os módulos
correspondentes aos processadores AMD.</p>

<p>Finalizada a configuração basta salvar e partir para a próxima etapa.</p>

<div class="highlight"><pre><code class="bash"><span class="nv">$ </span>sudo make bzImage
</code></pre></div>


<p>Essa é a parte demorada pois depende das escolhas que foram feitas no menu
de módulos e também do hardware. Após concluída com sucesso o novo kernel
estará disponível em <code>/usr/src/linux/arch/x86/boot</code>, caso seja 64 bits o
diretório será <code>/usr/src/linux/arch/ia64/boot</code>.
O novo kernel compilado ficará disponível com o nome de <code>bzImage</code>.</p>

<p>Após o fim da compilação do novo kernel é preciso ainda compilar e instalar os
módulos:</p>

<div class="highlight"><pre><code class="bash"><span class="nv">$ </span>sudo make modules
<span class="nv">$ </span>sudo make modules_install
</code></pre></div>


<p>Depois de instalar os módulos é necessário copiar os novos arquivos gerados
no processo de compilação para o boot, são eles: <code>.config</code>, <code>System.map</code> e
o kernel propriamente dito <code>bzImage</code>.</p>

<p>O <code>System.map</code> é uma tabela de símbolos do núcleo do sistema que serve de
consulta para verificar os endereços de cada símbolo na memória. Esse arquivo
é recriado a cada nova compilação.</p>

<p>Copie os arquivos para o <code>/boot</code>:</p>

<div class="highlight"><pre><code class="bash"><span class="nv">$ </span>cp /usr/src/linux/.config /boot/config
<span class="nv">$ </span>cp /usr/src/linux/System.map /boot/System.map
<span class="nv">$ </span>cp /usr/src/linux/arch/x86/boot/bzImage /boot/vmlinuz
</code></pre></div>


<p>E para finalizar, é preciso ajustar o gerenciador de boot (grub ou lilo)
para que ele carregue o novo kernel que foi compilado.</p>

<h3>Dicas finais</h3>

<p>Tudo o que foi mostrado deve funcionar sem problemas em qualquer distribuição
Linux. Você pode optar por automatizar esse processo de compilação criando um
script, no meu caso que uso Slackware mantenho um script como esse:</p>

<div class="highlight"><pre><code class="powershell"><span class="c">#!/bin/bash</span>

<span class="n">VERSION</span><span class="p">=</span><span class="s2">&quot;3.11.7&quot;</span>
<span class="n">CWD</span><span class="p">=</span><span class="s2">&quot;/usr/src&quot;</span>
<span class="n">cd</span> <span class="nv">$CWD</span>

<span class="n">rm</span> <span class="o">-f</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">src</span><span class="p">/</span><span class="n">linux</span>
<span class="n">ln</span> <span class="n">-s</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">src</span><span class="p">/</span><span class="n">linux</span><span class="p">-</span><span class="nv">$VERSION</span> <span class="p">/</span><span class="n">usr</span><span class="p">/</span><span class="n">src</span><span class="p">/</span><span class="n">linux</span>
<span class="n">cd</span> <span class="nv">$CWD</span><span class="p">/</span><span class="n">linux</span><span class="p">-</span><span class="nv">$VERSION</span>

<span class="n">cp</span> <span class="p">/</span><span class="n">boot</span><span class="p">/</span><span class="n">config</span> <span class="p">./.</span><span class="n">config</span>
<span class="n">make</span> <span class="n">oldconfig</span> <span class="p">&amp;&amp;</span> <span class="n">make</span> <span class="n">bzImage</span> <span class="p">&amp;&amp;</span> <span class="n">make</span> <span class="n">modules</span> <span class="p">&amp;&amp;</span> <span class="n">make</span> <span class="n">modules_install</span>

<span class="n">cd</span> <span class="p">/</span><span class="n">boot</span>
<span class="n">rm</span> <span class="o">-f</span> <span class="n">vmlinuz</span> <span class="n">System</span><span class="p">.</span><span class="n">map</span> <span class="n">config</span>
<span class="n">cp</span> <span class="nv">$CWD</span><span class="p">/</span><span class="n">linux</span><span class="p">-</span><span class="nv">$VERSION</span><span class="p">/.</span><span class="n">config</span> <span class="n">config</span><span class="p">-</span><span class="nv">$VERSION</span>
<span class="n">cp</span> <span class="nv">$CWD</span><span class="p">/</span><span class="n">linux</span><span class="p">-</span><span class="nv">$VERSION</span><span class="p">/</span><span class="n">System</span><span class="p">.</span><span class="n">map</span> <span class="p">/</span><span class="n">boot</span><span class="p">/</span><span class="n">System</span><span class="p">.</span><span class="n">map</span><span class="p">-</span><span class="nv">$VERSION</span>
<span class="n">cp</span> <span class="nv">$CWD</span><span class="p">/</span><span class="n">linux</span><span class="p">-</span><span class="nv">$VERSION</span><span class="p">/</span><span class="n">arch</span><span class="p">/</span><span class="n">x86</span><span class="p">/</span><span class="n">boot</span><span class="p">/</span><span class="n">bzImage</span> <span class="p">/</span><span class="n">boot</span><span class="p">/</span><span class="n">vmlinuz</span><span class="p">-</span><span class="nv">$VERSION</span>
<span class="n">ln</span> <span class="n">-s</span> <span class="n">vmlinuz</span><span class="p">-</span><span class="nv">$VERSION</span> <span class="n">vmlinuz</span>
<span class="n">ln</span> <span class="n">-s</span> <span class="n">System</span><span class="p">.</span><span class="n">map</span><span class="p">-</span><span class="nv">$VERSION</span> <span class="n">System</span><span class="p">.</span><span class="n">map</span>
<span class="n">ln</span> <span class="n">-s</span> <span class="n">config</span><span class="p">-</span><span class="nv">$VERSION</span> <span class="n">config</span>

<span class="n">lilo</span>
</code></pre></div>


<p>Pode ser adaptado para uso em outras distribuições sem complicações.</p>

<h4>Referências</h4>

<p><a href="http://www.amazon.com/Linux-Kernel-Development-3rd-Edition/dp/0672329468">Linux Kernel Development (3rd Edition)</a></p>

<p><a href="http://www.kroah.com/lkn/">Linux Kernel in a Nutshell</a></p>

</div>
<br />
<section class="read-more">
  <h3>Leia também</h3>
  <ul>
    
    <li>
      <span>04/03/2014</span> &raquo;
      <a href="/security/criando-uma-comunicacao-segura-com-openvpn">Criando uma comunicação segura com OpenVPN</a>
    </li>
    
    <li>
      <span>22/11/2013</span> &raquo;
      <a href="/security/conheca-o-metasploit-framework">Conheça o Metasploit Framework</a>
    </li>
    
    <li>
      <span>07/03/2014</span> &raquo;
      <a href="/server/gerencie-chaves-publicas-no-servidor-com-gist">Gerencie chaves públicas no servidor com gist</a>
    </li>
    
  </ul>
</section>
<br />
<section>
  <h3>Comentários</h3>
  <div id="disqus_thread" aria-live="polite">
    <script type="text/javascript">
  var disqus_shortname = 'infoslack';

  (function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = 'http://infoslack.disqus.com/embed.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script>

  </div>
</section>


      <div class="footer">
        <div class="contact">
          <p>
            Copyright © 2013 - 2014
          </p>
        </div>
      </div>
    </div>
    <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-44190365-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

  </body>
</html>
