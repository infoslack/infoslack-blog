<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8">
    <meta name="author" content="Daniel Romero" />
    <meta name="description" content="Automatize tarefas com monit"/>
    <meta name="keywords" content="server, linux, unix, services, servidor, monit, alertas, serviços"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="google-site-verification" content="-hEvNN86IOrYXeIdV4odleriXAkBE5PAV_Peb2niNZw" />
    <title>Automatize tarefas com monit</title>
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="/css/syntax.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
    <script type="text/javascript" src="//use.typekit.net/yed8yuc.js"></script>
    <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
  </head>
  <body>

    <div class="site">
      <div class="header">
        <h1 class="title"><a href="/">root@infoslack:~#</a></h1>
        <a class="extra" href="/">home</a>
        <a class="extra" href="/livro">livro</a>
        <a class="extra" href="/about">about</a>
        <a class="extra" href="http://infoslack.com/atom.xml"><i class="fa fa-rss"></i></a>
      </div>

      <h2>Automatize tarefas com monit</h2>
<p class="meta">06/03/2014</p>

<div class="post">
<p>Este é um complemento do <a href="http://infoslack.com/server/monitore-servicos-e-receba-alertas-com-monit/">post anterior</a> sobre monit e veremos como podemos automatizar
tarefas rotineiras.</p>

<p>No exemplo tenho uma aplicação Ruby on Rails e preciso restartar o meu servidor
de aplicações <a href="http://unicorn.bogomips.org/">Unicorn</a> a cada deploy. Para isso
o monit deve ficar de olho na minha aplicação aguardando que a mesma sofra
alterações após o processo de deploy e em seguida execute uma ação, no nosso
caso reiniciar o <em>Unicorn</em>.</p>

<p>Tenho um arquivo de <a href="http://upstart.ubuntu.com/">upstart</a> com instruções para inicializar o <em>Unicorn</em> e
dar o start na minha aplicação:</p>

<div class="highlight"><pre><code class="powershell"><span class="n">description</span> <span class="s2">&quot;rails_app server config&quot;</span>

<span class="n">pre-start</span> <span class="n">script</span>
  <span class="n">mkdir</span> <span class="n">-p</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">log</span><span class="p">/</span><span class="n">unicorn</span>
  <span class="n">chown</span> <span class="n">www-data</span><span class="p">.</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">log</span><span class="p">/</span><span class="n">unicorn</span>

  <span class="n">mkdir</span> <span class="n">-p</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">run</span><span class="p">/</span><span class="n">unicorn</span>
  <span class="n">chown</span> <span class="n">www-data</span><span class="p">.</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">run</span><span class="p">/</span><span class="n">unicorn</span>
<span class="k">end</span> <span class="n">script</span>

<span class="n">start</span> <span class="n">on</span> <span class="n">runlevel</span> <span class="p">[</span><span class="n">23</span><span class="p">]</span>
<span class="n">stop</span> <span class="n">on</span> <span class="n">shutdown</span>

<span class="n">exec</span> <span class="n">sudo</span> <span class="n">-u</span> <span class="n">www-data</span> <span class="n">sh</span> <span class="n">-c</span> <span class="s2">&quot;cd /var/www/rails_app/current &amp;&amp; \</span>
<span class="s2">bundle exec unicorn -c /etc/unicorn/rails_app.conf&quot;</span>

<span class="n">respawn</span>
</code></pre></div>


<p>Com o <em>upstart</em> posso executar chamadas para minha aplicação <code>sudo (start|stop|restart) rails_app</code>
sendo assim, agora posso explicar para o monit o que ele deve fazer.
A cada deploy executado, o comando <code>touch</code> será executado para criar um arquivo
chamado <em>restart.txt</em>, sempre que o touch é executado o arquivo gerado sofre
alteração em seu <a href="http://en.wikipedia.org/wiki/Timestamp">timestamp</a> é justamente com base nisso que o monit vai saber
quando executar a ação de restart.</p>

<p>Nossa configuração do monit ficará assim:</p>

<div class="highlight"><pre><code class="powershell"><span class="n">check</span> <span class="n">file</span> <span class="n">restart</span><span class="p">.</span><span class="n">txt</span> <span class="n">with</span> <span class="n">path</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">www</span><span class="p">/</span><span class="n">rails_app</span><span class="p">/</span><span class="n">shared</span><span class="p">/</span><span class="n">restart</span><span class="p">.</span><span class="n">txt</span>
  <span class="k">if</span> <span class="n">changed</span> <span class="n">timestamp</span>
    <span class="n">then</span> <span class="n">exec</span> <span class="s2">&quot;/usr/sbin restart rails_app&quot;</span>
</code></pre></div>


<p>O monit vai ficar de olho no arquivo <em>restart.txt</em> no diretório
<code>/var/www/rails_app/shared</code> e sempre que ele sofrer alteração em seu timestamp
a cada novo deploy, a ação de restart será executada.</p>

<p>Happy Hacking ;)</p>

</div>
<br />
<section class="read-more">
  <h3>Leia também</h3>
  <ul>
    
    <li>
      <span>05/03/2014</span> &raquo;
      <a href="/server/monitore-servicos-e-receba-alertas-com-monit">Monitore serviços e receba alertas com monit</a>
    </li>
    
    <li>
      <span>04/11/2013</span> &raquo;
      <a href="/linux/compilando-o-kernel-linux">Compilando o Kernel Linux</a>
    </li>
    
    <li>
      <span>07/03/2014</span> &raquo;
      <a href="/server/gerencie-chaves-publicas-no-servidor-com-gist">Gerencie chaves públicas no servidor com gist</a>
    </li>
    
  </ul>
</section>
<br />
<section>
  <h3>Comentários</h3>
  <div id="disqus_thread" aria-live="polite">
    <script type="text/javascript">
  var disqus_shortname = 'infoslack';

  (function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = 'http://infoslack.disqus.com/embed.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script>

  </div>
</section>


      <div class="footer">
        <div class="contact">
          <p>
            Copyright © 2013 - 2014
          </p>
        </div>
      </div>
    </div>
    <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-44190365-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

  </body>
</html>
